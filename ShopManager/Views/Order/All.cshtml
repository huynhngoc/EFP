@{
    ViewBag.Title = "Quản lý đơn hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="row">
    <div class="ibox-content">


        <h2>
            Danh sách đơn hàng
        </h2>

        <!-- toolbar -->
        <div class="" tooltip-demo m-t-md">
            <button onclick="refreshPage()" class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="left" title="Load lại trang"><i class="fa fa-refresh"></i> F5</button>
            <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="top" title="Thêm đơn hàng" onclick="createOrderModal()">+</button>


        </div>

        <!-- list order table -->
        <div class="table-responsive" style="padding: 0 15px 30px 20px">

            <table id="orderDataTable" class="table table-striped table-bordered table-hover" cellspacing="10" style="text-align:center">
                <thead>
                    <tr role="row" class="info">
                        <th class="col-md-1 dt-head-center">ID</th>
                        <th class="col-md-1 dt-head-center">Ngày tạo</th>
                        <th class="col-md-1 dt-head-center">Ngày sửa</th>
                        <th class="col-md-1 dt-head-center">Tình trạng</th>
                        <th class="col-md-1 dt-head-center">Thành tiền</th>
                        <th class="col-md-2 dt-head-center">Khách hàng</th>
                        <th class="col-md-1" style="width: auto;"></th>
                    </tr>
                </thead>
            </table>

        </div>
    </div>
</div>

<!-- edit order modal -->
<div class="modal inmodal fade" id="editOrderModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="margin-top: 10px; max-width:60%">
        <div class="modal-content">
            <div class="modal-header" style="padding: 10px 5px">
                <h4 class="modal-title" id="myModalLabel">Sửa đơn hàng</h4>
            </div>

            <div class="modal-body" style="padding-bottom:10px">
                <div style="font-style:italic">
                    <span><strong>Ngày tạo:</strong> <i id="edit_created"></i></span>
                    <span style="float:right"><strong>Sửa lần cuối:</strong> <i id="edit_modified"></i></span>
                </div>
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Đơn hàng ID:</label>
                        <div class="col-lg-10">
                            <label class="control-label" id="edit_orderId"></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Tên khách hàng:</label>
                        <a href="#" class="col-lg-10" id="edit_customer"></a>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Người nhận:</label>
                        <div class="col-lg-10">
                            <input id="edit_receiver" class="form-control" type="text">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Địa chỉ:</label>
                        <div class="col-lg-10">
                            <input id="edit_address" class="form-control" type="text">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Số điện thoại:</label>
                        <div class="col-lg-10">
                            <input id="edit_phone" class="form-control" type="text">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Tình trạng:</label>
                        <div id="edit_status" class="col-lg-10" data-toggle="buttons">
                            <label class="btn btn-info btn-outline">
                                <input type="radio" name="options" id="PROCESSING" autocomplete="off" checked> Chờ xử lý
                            </label>
                            <label class="btn btn-success btn-outline">
                                <input type="radio" name="options" id="DELIVERING" autocomplete="off"> Đang giao hàng
                            </label>
                            <label class="btn btn-primary btn-outline">
                                <input type="radio" name="options" id="COMPLETED" autocomplete="off"> <div>Xong</div>
                            </label>
                            <label class="btn btn-danger btn-outline">
                                <input type="radio" name="options" id="CANCELED" autocomplete="off"> <div>Hủy</div>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Ghi chú của khách hàng:</label>
                        <div class="col-lg-10">
                            <textarea type="text" id="edit_note" class="form-control" style="max-height:10vh; width:30vw; resize:none"></textarea>
                        </div>
                    </div>
                </form>
                <div style="overflow-y:auto; overflow-x:hidden; max-height:45vh">
                    <table id="edit_datatable" class="table table-striped table-bordered table-hover" cellspacing="10" style="text-align: center;">
                        <thead>
                            <tr>
                                <th class="col-md-2 dt-head-center">Sản phẩm</th>
                                <th class="col-md-1 dt-head-center">Số lượng</th>
                                <th class="col-md-2 dt-head-center">Giá từng sản phẩm</th>
                                <th class="col-md-2 dt-head-center">Tổng</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="form-group">
                    <label class="col-lg-2 control-label">Tổng:</label>
                    <label id="edit_total" class="col-lg-10 control-label"></label>
                </div>
            </div>
            <div class="modal-footer" style="padding: 10px">
                <button type="button" id="" class="btn btn-default" data-dismiss="modal">Huỷ</button>
                <button type="button" id="edit_save" class="btn btn-primary">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- create new order modal -->
<div class="modal inmodal fade" id="add_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="margin-top: 10px;">
        <div class="modal-content">
            <div class="modal-header" style="padding: 10px 5px">
                <h4 class="modal-title" id="myModalLabel">Thêm đơn hàng</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Khách hàng: </label>
                        <div class="col-lg-10">
                            <button type="button" class="btn btn-primary" id="btn_add_cust"><i class="fa fa-search"></i></button>
                            <label id="" class="order_custid control-label"></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Tình trạng:</label>
                        <div id="add_status" class="col-lg-10" data-toggle="buttons">
                            <label class="btn btn-info btn-outline">
                                <input type="radio" name="options" id="PROCESSING" autocomplete="off" checked> Chờ xử lý
                            </label>
                            <label class="btn btn-success btn-outline">
                                <input type="radio" name="options" id="DELIVERING" autocomplete="off"> Đang giao hàng
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Người nhận:</label>
                        <div class="col-lg-10">
                            <input class="form-control" id="add_receiver">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Địa chỉ tới:</label>
                        <div class="col-lg-10">
                            <input class="form-control" id="add_address">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Số điện thoại:</label>
                        <div class="col-lg-10">
                            <input class="form-control" id="add_phone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Ghi chú:</label>
                        <div class="col-lg-10">
                            <input class="form-control" id="add_note">
                        </div>
                    </div>
                </form>
                <button type="button" class="btn btn-primary" id="add_button" data-trigger="focus" data-container="body" data-toggle="popover" data-placement="top">Thêm hàng</button>
                <div class="table-responsive col-md-12">
                    <table class="table table-striped table-bordered table-hover" width="100%" cellspacing="10" style="text-align: center;" id="add_datatableproduct">
                        <thead>
                            <tr>
                                <th class="col-md-1">Mã</th>
                                <th class="col-md-5">Sản phẩm</th>
                                <th class="col-md-1">Số lượng</th>
                                <th class="col-md-2">Giá từng sản phẩm</th>
                                <th class="col-md-2">Tổng</th>
                                <th class="col-md-1"></th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="font-weight:bold; text-align:right">Tổng cộng</td>
                                <td id="table_total" colspan="2" style="font-weight:bold; text-align:left">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div id="popover_product" hidden>
                    <div class="table-responsive col-md-12">
                        <table id="popover_datatable" class="table table-bordered table-hover" width="100%" style="text-align: center;" aria-hidden="true">
                            <thead>
                                <tr>
                                    <th class="col-md-1">Mã</th>
                                    <th class="col-md-8">Sản phẩm</th>
                                    <th class="col-md-3">Đơn giá</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="" class="btn btn-default" data-dismiss="modal">Huỷ</button>
                <button type="button" id="add_add" class="btn btn-primary">Tạo</button>
            </div>
        </div>
    </div>
</div>

@*Choose customer*@
<div class="modal inmodal fade" id="choose_cust_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="margin-top: 10px;">
        <div class="modal-content">
            <div class="modal-header" style="padding: 10px 5px">
                <h5 class="modal-title" id="myModalLabel">Chọn khách hàng</h5>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Khách hàng: </label>
                        <span class="col-lg-3">
                            <label class="control-label" id="cust_name"></label>
                        </span>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Mã: </label>
                        <span class="col-lg-3">
                            <label class="control-label" id="cust_id"></label>
                        </span>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label">SĐT: </label>
                        <span class="col-lg-3">
                            <label class="control-label" id="cust_phone"></label>
                        </span>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Địa chỉ: </label>
                        <span class="col-lg-3">
                            <label class="control-label" id="cust_addr"></label>
                        </span>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Email: </label>
                        <span class="col-lg-3">
                            <label class="control-label" id="cust_email"></label>
                        </span>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Mô tả: </label>
                        <span class="col-lg-3">
                            <label class="control-label" id="cust_desc"></label>
                        </span>
                    </div>
                </form>
                <div class="table-responsive col-md-12">
                    <table class="table table-striped table-bordered table-hover" width="100%" cellspacing="10" style="text-align: center;" id="dt_choose_cust">
                        <thead>
                            <tr>
                                <th class="col-md-2">Mã</th>
                                <th class="col-md-3">Tên khách hàng</th>
                                <th class="col-md-2">SĐT</th>
                                <th class="col-md-5">Địa chỉ</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div></div>
            </div>
            <div class="modal-footer">
                <button type="button" id="" class="btn btn-default" data-dismiss="modal">Quay lại</button>
                <button type="button" id="btn_choose_cust" class="btn btn-primary">Chọn</button>
            </div>
        </div>
    </div>
</div>

<!--end content-->
@section CustomCSS{
    @Styles.Render("~/DataTable-CSS")
    @Styles.Render("~/SweetAlert-CSS")
    @Styles.Render("~/jQuery-UI-CSS")
    @Styles.Render("~/TouchSpin-CSS")

    <style>
        table.dataTable tbody tr.selected, table.dataTable tbody tr.selected:hover {
            background-color: #B0BED9;
        }

        #popover_product {
            width: 40vw;
            height: 25vh;
        }

        .search-left {
            float: left;
        }

        span.label-info {
            background-color: #c88c23;
        }

        .btn-info.btn-outline {
            color: #c88c23 !important;
        }

        .btn-outline {
            color: inherit ;
            background-color: transparent ;
            transition: all .5s ;
        }

        .btn-info {
            background-color: #c88c23;
            border-color: #c88c23 !important;
            color: #FFFFFF !important;
        }

            .btn-info:hover, .btn-info:focus, .btn-info.active, .btn-info.active:hover {
                background-color: #c88c23 !important;
                border-color: #c88c23 !important;
                color: #FFFFFF !important;
            }

        .popover {
            z-index: 5000; /* A value higher than 1010 that solves the problem */
            max-width: 100%;
        }

        .popover-content {
            color: #000000 !important; /*black color*/
        }

        .noTitleStuff {
            z-index: 500001;
            max-height: 34% !important;
            width: 500px !important;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, .1), 0 1px 10px rgba(0, 0, 0, .35);
        }

            .noTitleStuff .ui-dialog-titlebar {
                display: none;
            }
    </style>

}

@section CustomJS {

    <!-- Bundle -->
    @Scripts.Render("~/DataTable-JS")
    @Scripts.Render("~/SweetAlert-JS")
    @Scripts.Render("~/TouchSpin-JS")
    @Scripts.Render("~/jQuery-UI")
    @Scripts.Render("~/Utility-JS")

    @*Global code*@
    <script>
        //Auto open detail from id
        $(function() {
            try{
                @{string id="0";}
                @if (Request.Params["id"] !=null)
                {
                    id = Request.Params["id"];
                }
                var param_id = @id;

                if (param_id != "0"){
                    showOrderModal(param_id);
                }

            }
            catch (e){
                console.log("Lỗi");
            }
        });


        var languageConfig;
        languageConfig = {
            //            , "sInfoFiltered": " - lọc ra từ _MAX_ kết quả"
            //}
            "decimal": ",",
            "emptyTable": "Không có dữ liệu",
            "info": "Kết quả từ _START_ đến _END_ trong số _TOTAL_",
            "infoFiltered": " - lọc ra từ _MAX_ kết quả",
            "infoPostFix": "",
            "thousands": ".",
            "lengthMenu": "Show _MENU_ entries",
            "loadingRecords": "Đang tải ...",
            "processing": "Đang xử lý...",
            "search": "Tìm kiếm:",
            "searchPlaceholder": "Tên khách hàng...",
            "zeroRecords": "Không tìm thấy dữ liệu",
            "paginate": {
                "first": "Đầu",
                "last": "Cuối",
                "next": "Tiếp",
                "previous": "Trước"
            },
            "aria": {
                "sortAscending": ": sắp xếp tăng dần",
                "sortDescending": ": sắp xếp giảm dần"
            }
        }

        var mainTable;
        function loadDT() {
            mainTable = $("#orderDataTable").DataTable({
                "bProcessing": true
                    , "bServerSide": true
                    , "sAjaxSource": "/Order/GetOrderFromShopId"
                    , "aaSorting": [[2,'desc']]
                    , "aoColumnDefs": [{ "aTargets": [0], "mData": "Id" }
                            , {
                                "aTargets": [1], "mData": function (source) {
                                    return FormatDateVN(source.DateCreated);
                                }
                            }
                            , {
                                "aTargets": [2], "mData": function (source) {
                                    return FormatDateVN(source.DateModified);
                                }
                            }
                            , {
                                "aTargets": [3], "mData": function (source) {
                                    var status = source.Status;
                                    if (status == 2) {
                                        return '<span class="label label-success">Đang giao hàng</span>';
                                    }
                                    if (status == 3) {
                                        return '<span class="label label-primary">Đã xong</span>';
                                    }
                                    if (status == 4) {
                                        return '<span class="label label-danger">Đã huỷ</span>';
                                    }
                                    if (status == 1) {
                                        return '<span class="label label-info">Chờ xử lý</span>';
                                    }
                                }
                            }
                            , { "aTargets": [4], "mData": "Total" }
                            , { "aTargets": [5], "mData": "CustomerName" }
                            , {
                                "bSortable": false
                                , "aTargets": [-1]
                                //, "sDefaultContent": '<a id="" onclick="showOrderModal();" class="btn btn-default search-dropdown"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>Sửa</a>'
                                , "mData": function (data, type, row) {
                                    return '<a id="' + data[0] + '" onclick="showOrderModal(' + data.Id + ')" class="btn btn-success search-dropdown"><i class="fa fa-edit"></i></a>'
                                }
                            }
                    ]
                    , "fnInitComplete": function () {
                        $('#orderDataTable').removeAttr("style");
                        $('#orderDataTable').css("text-align", "center");
                    }
                    , "language": languageConfig
                //, "language": {
                //    "search": "Tìm kiếm:   ",
                //    "searchPlaceholder": "Tên khách hàng..."
                //}
                    , "destroy": true
                    , "iDisplayLength": 25
                //, "aLengthMenu": [5, 10, 25]
                    , "bLengthChange": false
                //, "dom": '<"top-search"f>rt<"bottom"ip><"clear">'
            });
        }

        loadDT();

        //F5
        function refreshPage() {
            mainTable.ajax.reload(null, false);
        }

    </script>

    @*Modal script*@
    <script>
        $('.modal').on('hidden.bs.modal', function (e) {
            if ($('.modal').hasClass('in')) {
                $('body').addClass('modal-open');
            }
        });
        //Edit order
        //Chưa làm total footer
        function showOrderModal(id) {

            var table = $('#edit_datatable').DataTable({
                "bProcessing": true
                , "bServerSide": true
                , "sAjaxSource": "/Order/GetOrderDetailFromOrderId"
                , "fnServerParams": function (aoData) {
                    aoData.push({ "name": "orderId", "value": id });
                }
                , "aoColumnDefs": [{ "aTargets": [0], "mData": 0 }
                        , { "aTargets": [1], "mData": 1 }
                        , { "aTargets": [2], "mData": 2 }
                        , { "aTargets": [3], "mData": 3 }
                ]
                , "fnInitComplete": function () {
                    GetOrderData();
                    $('#edit_datatable').removeAttr("style");
                    $('#edit_datatable').css("text-align", "center");

                    $("#edit_total").text(table.column(3).data().reduce(function (a, b) {
                        return a + b;
                    })+" VND");
                }
                , "paging": false
                , "searching": false
                , "ordering": false
                //, "scrollY": "30vh"
                //, "scrollX": "100%"
                //, "scrollCollapse": true
                //, "aLengthMenu": [5, 10, 25]
                , "bLengthChange": false
                , "info": false
                //, "ordering": false
                , "destroy": true
            })

            function GetOrderData() {
                $.get('/Order/GetDetailModel', { orderId: id }, function (data) {
                    $('#editOrderModal .modal-body').css("pointer-events","auto");
                    $("#edit_save").prop("disabled",false);
                    //Date
                    $('#edit_created').text(FormatDateTimeVN(data.DateCreated));
                    $('#edit_modified').text(FormatDateTimeVN(data.DateModified));

                    //Id
                    $('#edit_orderId').text(data.Id);

                    //Customer name
                    $('#edit_customer').text(data.CustomerName);
                    $('#edit_customer').attr("href", "/Customer?id=" + data.CustomerId);
                    $('#edit_customer').attr("target", "_blank");

                    //Receiver
                    $('#edit_receiver').val(data.Receiver);

                    //Address
                    $('#edit_address').val(data.ShippingAddress);

                    //Phone
                    $('#edit_phone').val(data.Phone);

                    //Note
                    $('#edit_note').text(data.Note);

                    //Status
                    ChangeStatus(data.Status);
                    if (data.Status == 4 || data.Status == 3){
                        $('#editOrderModal .modal-body').css("pointer-events","none");
                        $("#edit_save").prop("disabled",true);
                    }

                    $('#editOrderModal').modal('show');
                });
            }

            //Status
            function ChangeStatus(status) {
                $('#edit_status').find('.active').removeClass('active');
                $('#edit_status').find('.btn-primary').find('div').text('Xong');
                $('#edit_status').find('.btn-danger').find('div').text('Hủy');

                if (status == 2) {
                    $('#edit_status').find('.btn-success').addClass('active');
                }
                if (status == 3) {
                    $('#edit_status').find('.btn-primary').addClass('active');
                    $('#edit_status').find('.btn-primary').find('div').text('Đã xong');
                }
                if (status == 4) {
                    $('#edit_status').find('.btn-danger').addClass('active');
                    $('#edit_status').find('.btn-danger').find('div').text('Đã hủy');
                }
                if (status == 1) {
                    $('#edit_status').find('.btn-info').addClass('active');
                }
            }

        }

        //Create order
        function createOrderModal() {
            $('.order_custid').text("");
            $('.order_custid').attr('id',"");
            $('#add_status').find('.active').removeClass('active');
            $('#add_receiver').val("");
            $('#add_address').val("");
            $('#add_phone').val("");
            $('#add_note').val("");
            $('#add_datatableproduct').DataTable().rows().remove();

            var t = $('#add_datatableproduct').DataTable({
                "paging": false
                , "searching": false
                , "ordering": false
                //, "scrollY": "40vh"
                //, "scrollX": "100%"
                //, "scrollCollapse": true
                , "bLengthChange": false
                , "info": false
                , "destroy": true
                , "fnInitComplete": function () {
                    $('#add_modal').modal('show');
                }
            });

            $("#add_button").click(function (evt) {
                $("#popover_product").dialog({
                    autoOpen: false,
                    //appendTo: "#someElem",
                    draggable: true,
                    //height: 40vh,
                    //width: 700,
                    modal: true,
                    resizable: false,
                    dialogClass: 'noTitleStuff',
                    close: function (event, ui) { $('#wrap').show(); },
                    open: function (event, ui) {
                        CreatePopoverDT();
                        $('.ui-widget-overlay').bind('click', function () {
                            $("#popover_product").dialog('close');
                        });
                        $('.ui-widget-overlay').css(
                            "cssText", "background: none;z-index: 500000"
                        )

                    },
                    position: {
                        my: "left bottom",
                        at: "left top",
                        of: "#add_button"
                    }
                });
                //$("#popover_product").bind('clickoutside', function () {
                //    $("#popover_product").dialog('close');
                //});
                $("#popover_product").dialog("open");
            });

            $('#add_modal').modal('show');

            //Tạo popover datatable
            function CreatePopoverDT() {

                var table = $('#popover_datatable').DataTable({
                    "bProcessing": true
                    , "bServerSide": true
                    , "sAjaxSource": "/Product/GetAvailableProducts"
                    , "aoColumnDefs": [{ "aTargets": [0], "mData": "Id" }
                            , { "aTargets": [1], "mData": "Name" }
                            , { "aTargets": [2], "mData": "Price" }
                    ]
                    , "fnInitComplete": function () {
                        $('div.dataTables_filter input').focus();
                        //function row click
                        $('#popover_datatable tbody').unbind("click");
                        $('#popover_datatable tbody').on('click', 'tr', function () {
                            if ($(this).hasClass('selected')) {
                                //$(this).removeClass('selected');
                            }
                            else {
                                table.$('tr.selected').removeClass('selected');
                                $(this).addClass('selected');
                            }

                            var t = $('#add_datatableproduct').DataTable();
                            var id = table.cell('.selected', 0).data();
                            var tRow = t.row('#' + id);//table.cell('.selected', 0).data() + '');
                            if (tRow.index() == undefined) {

                                var rowNode = t.row.add([
                                    table.cell('.selected', 0).data(),
                                    table.cell('.selected', 1).data(),
                                    '<input class="form-control" type="text" name="quantity" id="' + table.cell('.selected', 0).data() + '" />',
                                    table.cell('.selected', 2).data(),
                                    table.cell('.selected', 2).data(),
                                    'Xóa'
                                ]).draw(false).node();
                                $(rowNode).attr('id', id);

                                $("input[id='" + id + "']").TouchSpin({
                                    min: 1,
                                    max: 100,
                                    initval: 1
                                }).on('change', function () {
                                    var id = $(this).attr('id');
                                    CalculateTotal($(this).val(), id);
                                });


                            }
                            else {
                                var val = $("input[id='" + id + "']").val();
                                if (val < 99) {
                                    $("input[id='" + id + "']").val(parseInt(val) + 1);
                                    CalculateTotal($("input[id='" + id + "']").val(), id);
                                }
                            }

                            //Calculate total on row
                            function CalculateTotal(q, id) {
                                var index = '#' + t.cell('#' + id, 0).data();
                                t.cell(index, 4).data(q * t.cell(index, 3).data());

                                $("#table_total").text(t.column(4).data().reduce(function (a, b) {
                                    return a + b;
                                }));
                            }
                        });

                    }
                    , "paging": false
                    , "searching": true
                    , "ordering": false
                    //, "scrollY": "30vh"
                    //, "scrollX": "100%"
                    //, "scrollCollapse": true
                    , "bLengthChange": false
                    , "language": {
                        "loadingRecords": "Đang tải ...",
                        "processing": "Đang xử lý...",
                        "search": "Tìm kiếm:",
                        "searchPlaceholder": "Tên sản phẩm...",
                        "zeroRecords": "Không tìm thấy dữ liệu"
                    }
                    , "info": false
                    , "destroy": true
                    , "dom": "<'search-left'f>t"
                })
            }
        }

        //Choose customer
        $('#btn_add_cust').click(function(){
            createChooseModal();
        });

        function createChooseModal(){
            $('#cust_name').text("");
            $('#cust_id').text("");
            $('#cust_desc').text("");
            $('#cust_addr').text("");
            $('#cust_phone').text("");
            $('#cust_email').text("");

            var table = $('#dt_choose_cust').DataTable({
                "bProcessing": true
                    , "bServerSide": true
                    , "sServerMethod": "POST"
                    , "sAjaxSource": "/Customer/GetAllCustomers"
                    , "aoColumnDefs": [{ "aTargets": [0], "mData": "CustomerId" }
                            , { "aTargets": [1], "mData": "Name" }
                            , { "aTargets": [2], "mData": "Phone" }
                            , { "aTargets": [3], "mData": "Address" }
                    ]                    
                    , "fnInitComplete": function () {
                        $('div.dataTables_filter input').focus();
                        //function row click
                        $('#dt_choose_cust tbody').unbind("click");
                        $('#dt_choose_cust tbody').on('click', 'tr', function () {
                            if ($(this).hasClass('selected')) {

                            }
                            else {
                                table.$('tr.selected').removeClass('selected');
                                $(this).addClass('selected');
                            }

                            var id = table.cell('.selected', 0).data();

                            $.ajax({
                                async: false,
                                method: 'GET',
                                url: '/Customer/GetCustomerById',
                                data: {
                                    "id": id
                                },
                                success: function (data) {
                                    console.log(data);

                                    $('#cust_name').text(data.Name);
                                    $('#cust_id').text(data.Id);
                                    $('#cust_desc').text(data.Description);
                                    $('#cust_addr').text(data.Address);
                                    $('#cust_phone').text(data.Phone);
                                    $('#cust_email').text(data.Email);
                                }
                            });
                        });

                        $('#choose_cust_modal').modal('show');

                    }
                    , "paging": false
                    , "searching": true
                    , "ordering": false
                //, "scrollY": "30vh"
                //, "scrollX": "100%"
                //, "scrollCollapse": true
                    , "bLengthChange": false
                    , "language": {
                        "loadingRecords": "Đang tải ...",
                        "processing": "Đang xử lý...",
                        "search": "Tìm kiếm:",
                        "searchPlaceholder": "Tên khách hàng...",
                        "zeroRecords": "Không tìm thấy dữ liệu"
                    }
                    , "info": false
                    , "destroy": true
                    , "dom": "<'search-left'f>t"
            });

        }

        $('#btn_choose_cust').click(function(){
            var id=$('#cust_id').text().trim();
            if (id.length > 0){
                $('.order_custid').attr('id', id);
                $('.order_custid').text($('#cust_name').text().trim());
                $('#choose_cust_modal').modal('hide');
            }
            else {
                alert('Chưa');
            }
        });
    </script>


    @*Update order*@
    <script>
        $("#edit_save").click(function () {
            var id = $("#edit_orderId").text();
            var status = ($.trim($("#edit_status").find(".active").find("input").attr("id")));
            var stat;
            if (status == "DELIVERING") {
                stat = 2;
            }
            if (status == "COMPLETED") {
                stat = 3;
            }
            if (status == "CANCELED") {
                stat = 4;
            }
            if (status == "PROCESSING") {
                stat = 1;
            }
            var receiver = $("#edit_receiver").val();
            var address = $("#edit_address").val();
            var phone = $("#edit_phone").val();
            var note = $("#edit_note").text();

            if (stat ==3){
                swal({
                    title: "Bạn muốn hoàn thành đơn hàng này?",
                    text: "Bạn sẽ không chỉnh sửa đơn hàng này được nữa!",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#1ab394",
                    confirmButtonText: "Đúng",
                    cancelButtonText: "Không",
                    closeOnConfirm: false
                },
                function(){
                    UpdateOrder(id, stat, receiver, address, phone, note);
                });
            }
            else if (stat ==4){
                swal({
                    title: "Bạn muốn hủy đơn hàng này?",
                    text: "Bạn sẽ không chỉnh sửa đơn hàng này được nữa!",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Hủy",
                    cancelButtonText: "Không",
                    closeOnConfirm: false
                },
                function(){
                    UpdateOrder(id, stat, receiver, address, phone, note);
                });
            }
            else {
                UpdateOrder(id, stat, receiver, address, phone, note);
            }
            
        });

        function UpdateOrder(id, status, receiver, address, phone, note) {
            $.post("/Order/UpdateOrder",
            {
                orderId: id,
                status: status,
                receiver: receiver,
                address: address,
                phone: phone,
                note: note
            },
            function (data, status) {
                if (data == "True") {
                    $("#editOrderModal").modal("hide");
                    swal({
                        title: "Thành công",
                        animation: "slide-from-top",
                        //text: "I will close in 2 seconds.",
                        type: "success",
                        timer: 1000,
                        showConfirmButton: false
                    });
                    console.log("end");
                } else {
                    swal({
                        title: "Có lỗi!",
                        animation: "slide-from-top",
                        text: "Sửa đơn hàng thất bại",
                        type: "warning",
                        timer: 1000,
                        showConfirmButton: false
                    });
                }
                loadDT();
            });
        }
    </script>

    @*Add order*@
    <script>
        $("#add_add").click(function () {
            var rs = "true";

            var t = $('#add_datatableproduct').DataTable();
            //details
            var arDetail = [];
            var rows = t.rows();
            if (rows.count() > 0) {
                for (i = 0; i < rows.count() ; i++) {
                    var data = t.rows(i).data()[0];
                    var productid = data[0];
                    var properties = data[1];
                    var quantity = $("input[id='" + productid + "']").val();
                    var price = data[3];

                    arDetail.push({ productid, properties, quantity, price});
                    }
                    }
                    else {
                rs = "chi tiết";
                //alert no detail
            }
            var cid=$('.order_custid').attr('id'); //hard code
            if (cid.length <=0){
                rs="khách hàng";
            }
            var note = $('#add_note').val();

            var status = ($.trim($("#add_status").find(".active").find("input").attr("id")));
            var iStatus=0;
            if (status.length <= 0) {
                rs = "tình trạng";
                //alert chưa chọn
            }
            else {
                iStatus = (status == "DELEIVERING")? 2:1;
            }
            var address = $('#add_address').val();
            var receiver = $('#add_receiver').val();
            var phone = $('#add_phone').val();

            if (rs == "true") {
                $.post('/Order/CreateOrder'
                    , {
                        custId: cid
                        , note: note
                        , status: iStatus
                        , address: address
                        , receiver: receiver
                        , phone: phone
                        , listDetail: arDetail
                    }
                    , function (data, status) {
                        if (data == "True") {
                            $("#add_modal").modal("hide");
                            swal({
                                title: "Thêm thành công",
                                animation: "slide-from-top",
                                type: "success",
                                showConfirmButton: true
                            });
                            refreshPage();
                        }
                        else {
                            swal({
                                title: "Cảnh báo",
                                animation: "slide-from-top",
                                text: "Thêm đơn hàng thất bại",
                                type: "warning",
                                showConfirmButton: true
                            });
                        }
                    }
                )
            }
            else {
                swal({
                    title: "Cảnh báo",
                    animation: "slide-from-top",
                    text: "Nhập thiếu " + rs+ " kìa",
                    type: "warning",
                    showConfirmButton: true
                });
            }

        });
    </script>
}
